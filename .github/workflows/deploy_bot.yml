name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Run deploy script on VPS
    runs-on: ubuntu-latest

    steps:
      - name: SSH Connection and Run Script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Agar biron buyruq xato ketsa, jarayonni to'xtatish
            set -e

            # Loyiha papkasi
            PROJECT_DIR="/root/erpnext_bot"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ SERVERGA ULANILDI. DEPLOY BOSHLANDI."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # 1. Papkaga kirish
            cd $PROJECT_DIR

            # 2. Kodni majburan yangilash (GitHub dagi kodni asosiy qilib olish)
            echo "ğŸ”„ Git yangilanmoqda..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "âœ… Kod muvaffaqiyatli yangilandi: $(git rev-parse --short HEAD)"

            # 3. Skriptga ishga tushirish ruxsatini berish
            chmod +x deploy_improved.sh

            # 4. SIZNING ISHLAYDIGAN SKRIPTINGIZNI YURGIZISH
            echo "âš¡ deploy_improved.sh ishga tushirilmoqda..."
            ./deploy_improved.sh

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… MUVAFFAQIYATLI YAKUNLANDI!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"