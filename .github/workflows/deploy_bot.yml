name: Deploy Telegram Bot (Polling Mode)

# Qachon ishga tushsin?
on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Qo'lda ishga tushirish tugmasi uchun

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Connect and Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Xatolik bo'lsa darhol to'xtash
            set -e

            # --- SOZLAMALAR ---
            BOT_DIR="/root/erpnext_bot"
            REPO_URL="https://github.com/${{ github.repository }}"

            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ CI/CD DEPLOYMENT BOSHLANDI"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            # 1. PAPKA VA GIT TEKSHIRUVI
            if [ -d "$BOT_DIR" ]; then
                echo "๐ Papka mavjud. Kirilmoqda..."
                cd $BOT_DIR

                if [ -d ".git" ]; then
                    echo "๐ Git yangilanmoqda (Force Sync)..."
                    # Eski o'zgarishlarni bekor qilib, GitHub bilan 1:1 qilamiz
                    git fetch origin main
                    git reset --hard origin/main
                    echo "โ Kod yangilandi: $(git rev-parse --short HEAD)"
                else
                    echo "โ๏ธ Git papkasi emas. Qayta klonlanmoqda..."
                    cd ..
                    rm -rf $BOT_DIR
                    git clone $REPO_URL $BOT_DIR
                    cd $BOT_DIR
                fi
            else
                echo "๐ Papka yo'q. Yangi klonlanmoqda..."
                git clone $REPO_URL $BOT_DIR
                cd $BOT_DIR
            fi

            # 2. ENV FAYLNI TEKSHIRISH
            if [ ! -f ".env" ]; then
                echo "โ XATO: .env fayli serverda mavjud emas!"
                echo "Iltimos, serverga kirib .env faylini yarating."
                exit 1
            fi

            echo ""
            echo "๐งน TOZALASH ISHLARI (CLEANUP)..."

            # 3. ESKI JARAYONLARNI O'LDIRISH
            # Deploy scriptga ishonmasdan, o'zimiz majburan o'chiramiz
            echo "๐ Eski bot jarayonlari to'xtatilmoqda..."
            pkill -9 -f "start_polling_bot" || true
            pkill -9 -f "python.*app.main" || true
            # Systemd servislari bo'lsa, ularni ham to'xtatamiz
            systemctl stop erpnext_bot 2>/dev/null || true
            
            # 4. KESHNI TOZALASH (ENG MUHIM QISM)
            # Eski kodlar qolib ketmasligi uchun
            echo "๐๏ธ Python kesh (.pyc) tozalanmoqda..."
            find . -name '*.pyc' -delete
            find . -type d -name '__pycache__' -exec rm -rf {} +
            echo "โ Kesh tozalandi!"

            # 5. RUXSATLARNI BERISH
            chmod +x deploy_improved.sh
            chmod +x deploy_polling.sh
            chmod +x start_polling_bot.py

            echo ""
            echo "โก BOTNI ISHGA TUSHIRISH..."

            # 6. DEPLOY SKRIPTINI YURGIZISH
            # Bizda improved script bo'lmasa, oddiysini ishlatamiz
            if [ -f "deploy_improved.sh" ]; then
                echo "โ deploy_improved.sh ishlatilmoqda..."
                ./deploy_improved.sh
            else
                echo "โ๏ธ deploy_improved.sh topilmadi, deploy_polling.sh ishlatilmoqda..."
                ./deploy_polling.sh
            fi

            echo ""
            echo "๐ STATUS TEKSHIRUVI..."
            
            # Bot ishga tushishini 5 soniya kutamiz
            sleep 5

            # Jarayon ishlayaptimi yo'qmi tekshiramiz
            if ps aux | grep -E "start_polling_bot" | grep -v grep > /dev/null; then
                echo "โ G'ALABA! Bot muvaffaqiyatli ishga tushdi."
                echo "๐ Ishlayotgan jarayon:"
                ps aux | grep "start_polling_bot" | grep -v grep
            else
                echo "โ XATO: Bot ishga tushmadi!"
                echo "๐ Loglarning oxirgi 20 qatori:"
                tail -20 bot_polling.log || echo "Log fayl topilmadi."
                exit 1
            fi

            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ DEPLOYMENT TUGADI"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"