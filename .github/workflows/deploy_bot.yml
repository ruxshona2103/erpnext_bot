name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Run deploy script on VPS
    runs-on: ubuntu-latest

    steps:
      - name: SSH Connection and Run Script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          # ---------------------------------------------------
          # O'ZGARISH SHU YERDA: envs ga TERM qo'shish yoki script ichida export qilish
          # Eng osoni script ichida export qilish:
          # ---------------------------------------------------
          script: |
            # 1. Terminal turini belgilash (Robot ekanligini bildirmaslik uchun)
            export TERM=xterm

            # Agar biron buyruq xato ketsa, jarayonni to'xtatish
            set -e

            # Loyiha papkasi
            PROJECT_DIR="/root/erpnext_bot"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ SERVERGA ULANILDI. DEPLOY BOSHLANDI."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # 2. Papkaga kirish
            cd $PROJECT_DIR

            # 3. Kodni majburan yangilash
            echo "ğŸ”„ Git yangilanmoqda..."
            git fetch origin main
            git reset --hard origin/main
            
            echo "âœ… Kod muvaffaqiyatli yangilandi: $(git rev-parse --short HEAD)"

            # 4. Ruxsat berish
            chmod +x deploy_improved.sh

            # 5. SKRIPTNI YURGIZISH
            echo "âš¡ deploy_improved.sh ishga tushirilmoqda..."
            ./deploy_improved.sh

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… MUVAFFAQIYATLI YAKUNLANDI!!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"