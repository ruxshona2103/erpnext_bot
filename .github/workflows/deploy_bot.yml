name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e  # Exit on any error

            # Papka manzili
            BOT_DIR="/root/erpnext_bot"
            REPO_URL="https://github.com/${{ github.repository }}"

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸš€ CI/CD Deployment Started"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            # 1. Papka borligini tekshiramiz
            if [ -d "$BOT_DIR" ]; then
                echo "âœ… Directory exists: $BOT_DIR"
                cd $BOT_DIR

                # 2. Git repo ekanligini tekshiramiz
                if [ -d ".git" ]; then
                    echo "ğŸ”„ Updating code from GitHub..."

                    # Show current status
                    echo "Current commit: $(git rev-parse --short HEAD)"

                    # Fetch and update
                    git fetch origin main
                    git reset --hard origin/main

                    echo "Updated to: $(git rev-parse --short HEAD)"
                    echo "Latest commit: $(git log -1 --format='%s')"
                else
                    echo "âš ï¸  Directory exists but not a git repo. Re-cloning..."
                    cd ..
                    rm -rf $BOT_DIR
                    git clone $REPO_URL $BOT_DIR
                    cd $BOT_DIR
                fi
            else
                echo "ğŸ†• Directory not found. Cloning fresh..."
                git clone $REPO_URL $BOT_DIR
                cd $BOT_DIR
            fi

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âš¡ Executing IMPROVED deploy script..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            # 3. Check .env file
            if [ ! -f ".env" ]; then
                echo "âŒ ERROR: .env file is missing!"
                exit 1
            fi

            # 4. Make scripts executable
            chmod +x deploy_improved.sh
            chmod +x deploy_polling.sh
            chmod +x start_polling_bot.py
            chmod +x check_deployment.sh

            # 5. Run IMPROVED deploy script (not the old one!)
            if [ -f "deploy_improved.sh" ]; then
                echo "âœ… Using deploy_improved.sh (recommended)"
                ./deploy_improved.sh
            else
                echo "âš ï¸  deploy_improved.sh not found, using deploy_polling.sh"
                ./deploy_polling.sh
            fi

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸ” Verifying deployment..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo ""

            # 6. Verify bot is running
            if ps aux | grep -E "start_polling_bot" | grep -v grep > /dev/null; then
                echo "âœ… Bot process is RUNNING"
                ps aux | grep "start_polling_bot" | grep -v grep
            else
                echo "âŒ ERROR: Bot process is NOT running!"
                echo ""
                echo "Last 20 lines of log:"
                tail -20 bot_polling.log || echo "No log file found"
                exit 1
            fi

            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… Deployment Completed Successfully!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"