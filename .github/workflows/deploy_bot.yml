name: Deploy Telegram Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            # Papka manzili
            BOT_DIR="/root/erpnext_bot"
            REPO_URL="https://github.com/${{ github.repository }}"
            
            echo "üöÄ Deployment Started..."
            
            # 1. Papka borligini tekshiramiz
            if [ -d "$BOT_DIR" ]; then
                echo "‚úÖ Directory exists. Entering..."
                cd $BOT_DIR
                
                # 2. Git repo ekanligini tekshiramiz
                if [ -d ".git" ]; then
                    echo "üîÑ Updating code..."
                    git fetch origin main
                    git reset --hard origin/main
                else
                    echo "‚ö†Ô∏è Directory exists but not a git repo. Re-cloning..."
                    cd ..
                    rm -rf $BOT_DIR
                    git clone $REPO_URL $BOT_DIR
                    cd $BOT_DIR
                fi
            else
                echo "üÜï Directory not found. Cloning fresh..."
                git clone $REPO_URL $BOT_DIR
                cd $BOT_DIR
            fi
            
            # 3. Deploy skriptini ishga tushiramiz
            echo "‚ö° Executing deploy script..."
            
            # Agar .env fayl yo'q bo'lsa, ogohlantirish (lekin sizda bor)
            if [ ! -f ".env" ]; then
                echo "‚ö†Ô∏è  WARNING: .env file is missing! Bot might fail."
            fi
            
            chmod +x deploy_polling.sh
            chmod +x start_polling_bot.py
            
            ./deploy_polling.sh
            
            echo "‚úÖ Deployment Finished Successfully!"