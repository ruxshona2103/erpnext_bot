=============================================================================
  ERPNEXT TELEGRAM BOT - TO'LIQ QOLLANMA
=============================================================================

Yaratilgan: 2025-01-19
Muallif: Claude Code (Anthropic)
Versiya: 2.0 (Professional Edition with Redis)

=============================================================================
  üìã MUNDARIJA
=============================================================================

1. UMUMIY MA'LUMOT
2. O'ZGARISHLAR RO'YXATI
3. YANGI ARXITEKTURA
4. O'RNATISH VA SOZLASH
5. QANDAY ISHLAYDI?
6. FAYLLAR STRUKTURASI
7. AUTHENTICATION TIZIMI
8. ERPNEXT API INTEGRATION
9. REDIS VA FSM STORAGE
10. TROUBLESHOOTING
11. KEYINGI QADAMLAR

=============================================================================
  1. UMUMIY MA'LUMOT
=============================================================================

Bu bot ERPNext ERP tizimi bilan integratsiyalashgan professional Telegram bot.

ASOSIY XUSUSIYATLAR:
-------------------
‚úÖ Passport ID orqali birinchi marta kirish
‚úÖ Keyingi safar avtomatik kirish (Telegram ID orqali)
‚úÖ Customer profil ma'lumotlari
‚úÖ Shartnomalar va mahsulot detallari
‚úÖ To'lovlar tarixi
‚úÖ To'lov jadvali
‚úÖ Avtomatik to'lov eslatmalari
‚úÖ Persistent storage (Redis)
‚úÖ Professional error handling
‚úÖ Retry logic (tarmoq xatolarida avtomatik qayta urinish)

TEXNOLOGIYALAR:
--------------
- Python 3.11
- aiogram 3.22.0 (Telegram Bot Framework)
- FastAPI 0.121.2 (Web Framework)
- Redis 5.0.1 (Persistent Storage)
- httpx 0.28.1 (Async HTTP Client)
- Tenacity 8.2.3 (Retry Logic)
- Loguru 0.7.3 (Logging)

=============================================================================
  2. O'ZGARISHLAR RO'YXATI
=============================================================================

ASOSIY O'ZGARISHLAR:
-------------------

1. REDIS STORAGE (MemoryStorage o'rniga)
   ‚ùå Oldin: MemoryStorage - restart'da hamma yo'qoladi
   ‚úÖ Hozir: RedisStorage - restart'dan keyin ham saqlanadi

   Nima beradi?
   - User bir marta passport kiritadi
   - Keyingi safar avtomatik taniladi (server restart bo'lsa ham)
   - State'lar saqlanadi
   - Production ready

2. ERPNEXT API YANGILANDI
   ‚ùå Oldin: Inconsistent endpoint'lar
   ‚úÖ Hozir: To'liq dokumentatsiyalangan, retry logic bilan

   Yangi endpoint'lar:
   - erp_get_customer_by_telegram_id() - avtomatik kirish
   - erp_get_customer_by_passport() - birinchi marta kirish
   - erp_get_customer_contracts() - batafsil mahsulotlar bilan
   - erp_get_payment_schedule() - to'lov jadvali
   - erp_get_payment_history() - to'lovlar tarixi
   - erp_get_upcoming_payments() - yaqin to'lovlar
   - erp_get_customers_needing_reminders() - eslatma yuborish kerak bo'lganlar

3. AUTHENTICATION TIZIMI
   ‚úÖ Passport orqali birinchi marta kirish
   ‚úÖ Telegram ID avtomatik ERPNext'ga saqlanadi
   ‚úÖ Keyingi safar avtomatik taniladi
   ‚úÖ Xavfsiz: bitta passport = bitta telegram

4. FORMATTERS YANGILANDI
   ‚úÖ ERPNext API response bilan 100% mos
   ‚úÖ Mahsulot detallari (nom, miqdor, narx foiz bilan)
   ‚úÖ To'lov jadvali batafsil
   ‚úÖ Yaqin to'lovlar (emoji bilan)

5. KEYBOARD BUILDER TUZATILDI
   ‚ùå Oldin: Deprecated kb.add() syntax
   ‚úÖ Hozir: Aiogram 3.x to'g'ri syntax (inline_keyboard parameter)

6. HANDLER'LAR QAYTA YOZILDI
   ‚úÖ start.py - telegram_id tekshirish, avtomatik kirish
   ‚úÖ passport.py - passport validation, avtomatik linking
   ‚úÖ Professional error handling
   ‚úÖ Retry logic tarmoq xatolari uchun

7. CONFIGURATION
   ‚úÖ Redis configuration qo'shildi
   ‚úÖ .env.example yaratildi
   ‚úÖ Pydantic validation

=============================================================================
  3. YANGI ARXITEKTURA
=============================================================================

ARXITEKTURA DIAGRAMMASI:
------------------------

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         USER (Telegram)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    TELEGRAM BOT (aiogram)                        ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îÇ
‚îÇ  ‚îÇ   Handlers   ‚îÇ  ‚îÇ  Formatters  ‚îÇ  ‚îÇ   Keyboards  ‚îÇ          ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                ‚îÇ                              ‚îÇ
      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
      ‚îÇ                  ‚îÇ          ‚îÇ                    ‚îÇ
      ‚ñº                  ‚ñº          ‚ñº                    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Redis   ‚îÇ      ‚îÇ  ERPNext   ‚îÇ ‚îÇ  Logs   ‚îÇ      ‚îÇ  States  ‚îÇ
‚îÇ Storage  ‚îÇ      ‚îÇ    API     ‚îÇ ‚îÇ (loguru)‚îÇ      ‚îÇ   (FSM)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                  ‚îÇ
      ‚îÇ                  ‚îÇ
      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  ERPNext DB    ‚îÇ
    ‚îÇ  (Customer,    ‚îÇ
    ‚îÇ   Contracts,   ‚îÇ
    ‚îÇ   Payments)    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

KOMPONENTLAR:
------------

1. LOADER (app/loader.py)
   - Bot instance yaratish
   - Redis connection
   - RedisStorage sozlash
   - Dispatcher yaratish
   - Startup/shutdown handlers

2. HANDLERS (app/handlers/)
   - start.py: /start command, avtomatik login
   - passport.py: Birinchi marta kirish
   - menu.py: Main menu
   - contract.py: Shartnomalar
   - payments.py: To'lovlar
   - reminders.py: Eslatmalar (yangi)

3. SERVICES (app/services/)
   - erpnext_api.py: ERPNext API integration
   - notification.py: Background worker (eslatmalar)

4. UTILS (app/utils/)
   - formatters.py: Message formatlash
   - keyboard.py: Keyboard builders

5. STATES (app/states/)
   - user_states.py: FSM state'lar

6. CONFIG (app/config.py)
   - Pydantic configuration models
   - Environment variables validation

=============================================================================
  4. O'RNATISH VA SOZLASH
=============================================================================

QADAM 1: REDIS O'RNATISH
------------------------

Ubuntu/Debian:
```bash
sudo apt update
sudo apt install redis-server
sudo systemctl start redis
sudo systemctl enable redis
```

Tekshirish:
```bash
redis-cli ping
# Javob: PONG (demak ishlayapti)
```

QADAM 2: PYTHON DEPENDENCIES O'RNATISH
--------------------------------------

```bash
cd /home/ruxshona/Documents/erpnext_bot
pip install -r requirements.txt
```

QADAM 3: .env FAYLI YARATISH
----------------------------

```bash
cp .env.example .env
nano .env
```

To'ldirish kerak bo'lgan field'lar:
- BOT_TOKEN: @BotFather'dan olgan token
- ERP_BASE_URL: ERPNext server URL'i
- ERP_API_KEY: ERPNext API key
- ERP_API_SECRET: ERPNext API secret
- REDIS_HOST: Redis server (localhost)
- REDIS_PORT: Redis port (6379)

QADAM 4: ERPNEXT'DA YANGI ENDPOINT QO'SHISH
-------------------------------------------

ERPNext'da quyidagi endpoint qo'shilishi kerak:

Fayl: [your_app]/api/telegram_bot_api.py

Qo'shish kerak bo'lgan function:

```python
@frappe.whitelist(allow_guest=True)
def get_customer_by_telegram_id(telegram_id):
    """
    Telegram ID orqali customer topish - avtomatik login uchun.
    """
    try:
        customer = frappe.db.get_value(
            "Customer",
            {"custom_telegram_id": str(telegram_id)},
            ["name"],
            as_dict=False
        )

        if customer:
            # customer topildi - to'liq ma'lumotlarni qaytarish
            return get_customer_by_id(customer, telegram_id)
        else:
            return {
                "success": False,
                "message": "Customer topilmadi"
            }
    except Exception as e:
        frappe.log_error(str(e), "Get Customer by Telegram ID Error")
        return {
            "success": False,
            "message": str(e)
        }
```

QADAM 5: BOT ISHGA TUSHIRISH
-----------------------------

Development (local):
```bash
python -m app.main
```

Production (systemd service):
```bash
sudo nano /etc/systemd/system/erpnext-bot.service
```

Service fayli:
```ini
[Unit]
Description=ERPNext Telegram Bot
After=network.target redis.service

[Service]
Type=simple
User=ruxshona
WorkingDirectory=/home/ruxshona/Documents/erpnext_bot
Environment="PATH=/home/ruxshona/Documents/erpnext_bot/.venv/bin"
ExecStart=/home/ruxshona/Documents/erpnext_bot/.venv/bin/python -m app.main
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

Ishga tushirish:
```bash
sudo systemctl daemon-reload
sudo systemctl start erpnext-bot
sudo systemctl enable erpnext-bot
sudo systemctl status erpnext-bot
```

=============================================================================
  5. QANDAY ISHLAYDI?
=============================================================================

SCENARIO 1: BIRINCHI MARTA KIRISH
---------------------------------

1. User /start bosadi
   ‚îî‚îÄ> Bot: "Assalomu alaykum! Ma'lumotlaringiz tekshirilmoqda..."

2. Bot telegram_id ni ERPNext'da tekshiradi
   API: erp_get_customer_by_telegram_id(telegram_id)
   ‚îî‚îÄ> ERPNext: "Topilmadi" (birinchi marta)

3. Bot passport so'raydi
   ‚îî‚îÄ> Bot: "Passport ID ni kiriting: AB1234567"

4. User passport kiritadi: "AB1234567"

5. Bot passport'ni validate qiladi (2 harf + 7 raqam)
   ‚îî‚îÄ> Valid ‚úÖ

6. Bot ERPNext'ga murojaat qiladi
   API: erp_get_customer_by_passport("AB1234567", telegram_id)

7. ERPNext:
   - Passport bo'yicha customer topadi: "CUST-00001"
   - Telegram_id ni customer'ga saqlayyapti
   - To'liq ma'lumotlarni qaytaradi (contracts, payments, etc.)

8. Bot customer profilini ko'rsatadi
   ‚îî‚îÄ> "Muvaffaqiyatli! Sizning account bog'landi.
        Keyingi safar avtomatik tanilasiz! üéâ"

9. Redis'ga state saqlanadi
   ‚îî‚îÄ> customer_id, telegram_id, passport

SCENARIO 2: IKKINCHI MARTA KIRISH (AVTOMATIK)
---------------------------------------------

1. User /start bosadi
   ‚îî‚îÄ> Bot: "Assalomu alaykum! Ma'lumotlaringiz tekshirilmoqda..."

2. Bot telegram_id ni ERPNext'da tekshiradi
   API: erp_get_customer_by_telegram_id(telegram_id)
   ‚îî‚îÄ> ERPNext: "Topildi! CUST-00001" ‚úÖ

3. ERPNext to'liq ma'lumotlarni qaytaradi
   - Customer info
   - Contracts
   - Upcoming payments

4. Bot profilni ko'rsatadi
   ‚îî‚îÄ> "Xush kelibsiz, Ali Aliyev!"
   ‚îî‚îÄ> Profile, contracts, upcoming payments

5. Passport so'ralmaydi! ‚úÖ

SCENARIO 3: SHARTNOMA KO'RISH
-----------------------------

1. User: "üìÑ Mening shartnomalarim" bosadi

2. Bot telegram_id orqali customer_id topadi (Redis'dan)

3. ERPNext'dan shartnomalar oladi
   API: erp_get_customer_contracts(customer_id)

4. Shartnomalar inline keyboard bilan ko'rsatiladi
   ‚îî‚îÄ> [üìÑ SAL-ORD-00001]
   ‚îî‚îÄ> [üìÑ SAL-ORD-00002]

5. User shartnomani tanlaydi

6. Bot batafsil ma'lumot ko'rsatadi:
   - Umumiy summa
   - To'langan
   - Qarz
   - MAHSULOTLAR (nomi, miqdori, narxi foiz bilan)
   - Keyingi to'lov

=============================================================================
  6. FAYLLAR STRUKTURASI
=============================================================================

erpnext_bot/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ config.py               # Configuration (Pydantic)
‚îÇ   ‚îú‚îÄ‚îÄ loader.py               # Bot, Redis, Dispatcher initialization
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ handlers/               # Message handlers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py           # /start - avtomatik login ‚úÖ YANGILANDI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ passport.py        # Passport authentication ‚úÖ YANGILANDI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ menu.py            # Main menu
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contract.py        # Shartnomalar
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payments.py        # To'lovlar
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ (reminders.py)     # Eslatmalar (qo'shilishi kerak)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/              # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ erpnext_api.py    # ERPNext API ‚úÖ TO'LIQQA QAYTA YOZILDI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ notification.py    # Background worker
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ states/                # FSM states
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user_states.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ utils/                 # Utilities
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ formatters.py     # Message formatters ‚úÖ YANGILANDI
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ keyboard.py       # Keyboard builders ‚úÖ TUZATILDI
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ webhook/               # FastAPI webhook
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ server.py
‚îÇ
‚îú‚îÄ‚îÄ requirements.txt           # Python dependencies ‚úÖ YANGILANDI
‚îú‚îÄ‚îÄ .env.example              # Environment template ‚úÖ YANGI
‚îú‚îÄ‚îÄ .env                      # Environment variables (SECRET!)
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ LICENSE
‚îî‚îÄ‚îÄ QOLLANMA.txt              # Bu fayl ‚úÖ YANGI

=============================================================================
  7. AUTHENTICATION TIZIMI
=============================================================================

AUTHENTICATION FLOW CHART:
-------------------------

                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ  User Start ‚îÇ
                     ‚îÇ   /start    ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
                  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                  ‚îÇ Check telegram_id    ‚îÇ
                  ‚îÇ in ERPNext?          ‚îÇ
                  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ         ‚îÇ
                  Found    Not Found
                    ‚îÇ         ‚îÇ
                    ‚îÇ         ‚ñº
                    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ    ‚îÇ Ask Passport ‚îÇ
                    ‚îÇ    ‚îÇ   ID         ‚îÇ
                    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ           ‚îÇ
                    ‚îÇ           ‚ñº
                    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ    ‚îÇ Validate     ‚îÇ
                    ‚îÇ    ‚îÇ Format       ‚îÇ
                    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ           ‚îÇ
                    ‚îÇ      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ      ‚îÇ         ‚îÇ
                    ‚îÇ    Valid    Invalid
                    ‚îÇ      ‚îÇ         ‚îÇ
                    ‚îÇ      ‚îÇ         ‚ñº
                    ‚îÇ      ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ      ‚îÇ    ‚îÇ  Error  ‚îÇ
                    ‚îÇ      ‚îÇ    ‚îÇ  Message‚îÇ
                    ‚îÇ      ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ      ‚îÇ
                    ‚îÇ      ‚ñº
                    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  ‚îÇ ERPNext API  ‚îÇ
                    ‚îÇ  ‚îÇ Check        ‚îÇ
                    ‚îÇ  ‚îÇ Passport     ‚îÇ
                    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ         ‚îÇ
                    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ    ‚îÇ         ‚îÇ
                    ‚îÇ  Found    Not Found
                    ‚îÇ    ‚îÇ         ‚îÇ
                    ‚îÇ    ‚îÇ         ‚ñº
                    ‚îÇ    ‚îÇ    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ    ‚îÇ    ‚îÇ  Error  ‚îÇ
                    ‚îÇ    ‚îÇ    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ    ‚îÇ
                    ‚îÇ    ‚ñº
                    ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ  ‚îÇ Link         ‚îÇ
                    ‚îÇ  ‚îÇ telegram_id  ‚îÇ
                    ‚îÇ  ‚îÇ to Customer  ‚îÇ
                    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ         ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                     ‚îÇ Show Profile     ‚îÇ
                     ‚îÇ + Contracts      ‚îÇ
                     ‚îÇ + Payments       ‚îÇ
                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

XAVFSIZLIK:
----------

1. Bitta passport = bitta telegram_id
   - ERPNext'da tekshiriladi
   - Agar passport allaqachon boshqa telegram'ga bog'langan bo'lsa - xato

2. Bitta telegram_id = bitta passport
   - Bir kishi faqat bir marta passport kiritadi
   - Keyingi safar avtomatik taniladi

3. Passport validation
   - Regex: ^[A-Z]{2}\d{7}$ (AA1234567)
   - ERPNext'da ham tekshiriladi

4. Session persistence
   - Redis'da saqlanadi
   - Server restart'dan keyin ham saqlanadi

=============================================================================
  8. ERPNEXT API INTEGRATION
=============================================================================

BARCHA ENDPOINT'LAR:
-------------------

1. AUTHENTICATION
   ‚îú‚îÄ erp_get_customer_by_telegram_id(telegram_id)
   ‚îÇ  ‚îî‚îÄ> Avtomatik login - telegram_id bo'yicha customer topish
   ‚îÇ
   ‚îî‚îÄ erp_get_customer_by_passport(passport, telegram_chat_id)
      ‚îî‚îÄ> Birinchi marta login - passport va telegram_id bog'lash

2. CONTRACTS
   ‚îú‚îÄ erp_get_customer_contracts(customer_id)
   ‚îÇ  ‚îî‚îÄ> Barcha shartnomalar (mahsulotlar bilan!)
   ‚îÇ
   ‚îî‚îÄ erp_get_payment_schedule(contract_id)
      ‚îî‚îÄ> To'lov jadvali (oylik to'lovlar)

3. PAYMENTS
   ‚îú‚îÄ erp_get_payment_history(contract_id)
   ‚îÇ  ‚îî‚îÄ> To'lovlar tarixi (Payment Entry)
   ‚îÇ
   ‚îî‚îÄ erp_get_upcoming_payments(customer_id)
      ‚îî‚îÄ> Yaqin to'lovlar (barcha shartnomalar)

4. NOTIFICATIONS
   ‚îú‚îÄ erp_get_customers_needing_reminders(reminder_days)
   ‚îÇ  ‚îî‚îÄ> Eslatma yuborish kerak bo'lgan customerlar
   ‚îÇ
   ‚îú‚îÄ erp_get_today_reminders()
   ‚îÇ  ‚îî‚îÄ> Bugun eslatma yuborish kerak bo'lganlar
   ‚îÇ
   ‚îî‚îÄ erp_get_overdue_customers()
      ‚îî‚îÄ> Kechiktirganlar

API RESPONSE STRUCTURE:
----------------------

get_customer_by_telegram_id() / get_customer_by_passport():
{
    "success": true,
    "customer": {
        "customer_id": "CUST-00001",
        "customer_name": "Ali Aliyev",
        "phone": "+998901234567",
        "passport": "AB1234567",
        "telegram_id": "123456789"
    },
    "contracts": [
        {
            "contract_id": "SAL-ORD-00001",
            "contract_date": "15.01.2025",
            "total_amount": 15000000,
            "paid": 5000000,
            "remaining": 10000000,
            "products": [
                {
                    "name": "Samsung Galaxy S24",
                    "qty": 2,
                    "price": 7000000,      # TAN NARX + FOIZ
                    "total_price": 14000000,
                    "imei": "123456789",
                    "notes": "Qora rang"
                }
            ],
            "payments_history": [...],
            "next_payment": {...}
        }
    ],
    "next_payments": [...],
    "is_new_link": true
}

RETRY LOGIC:
-----------

Barcha API call'larda tenacity retry logic ishlatilgan:

- Network error ‚Üí 3 marta qayta urinadi
- Timeout ‚Üí 3 marta qayta urinadi
- Kutish vaqti: 2s ‚Üí 4s ‚Üí 8s (exponential backoff)
- HTTP error (4xx, 5xx) ‚Üí retry qilmaydi, error qaytaradi

Kod:
```python
@retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=2, max=10),
    retry=retry_if_exception_type((httpx.TimeoutException, httpx.NetworkError)),
)
async def erp_request(method, endpoint, params, data):
    ...
```

=============================================================================
  9. REDIS VA FSM STORAGE
=============================================================================

NIMA UCHUN REDIS?
----------------

MemoryStorage vs RedisStorage:

| Xususiyat           | MemoryStorage | RedisStorage |
|---------------------|---------------|--------------|
| Tezlik              | ‚ö°‚ö°‚ö°          | ‚ö°‚ö°‚ö°         |
| Persistent          | ‚ùå            | ‚úÖ           |
| Server restart      | ‚ùå Yo'qoladi  | ‚úÖ Saqlanadi |
| Production ready    | ‚ùå            | ‚úÖ           |
| Setup qiyinligi     | ‚úÖ Oson       | ‚ö†Ô∏è Redis kerak|
| User experience     | ‚ùå Yomon      | ‚úÖ Yaxshi    |

REDIS'DA NIMA SAQLANADI?
------------------------

1. FSM States (aiogram)
   - Qaysi state'da (PassportState.waiting_for_passport)
   - Conversation flow

2. User Data (aiogram FSM data)
   - customer_id
   - customer_name
   - telegram_id
   - passport

3. Redis keys format:
   ```
   fsm:{bot_id}:{chat_id}:{user_id}:state  ‚Üí State
   fsm:{bot_id}:{chat_id}:{user_id}:data   ‚Üí Data
   ```

REDIS COMMANDS (DEBUGGING):
---------------------------

Redis'da nima bor ko'rish:
```bash
redis-cli

# Barcha key'larni ko'rish
KEYS *

# Biror key'ning qiymatini ko'rish
GET "fsm:8448405800:123456789:123456789:state"

# Barcha FSM ma'lumotlarini o'chirish (EHTIYOT!)
FLUSHDB

# Redis'ni to'xtatish
EXIT
```

REDIS KONFIGURATSIYASI:
----------------------

loader.py:
```python
redis = Redis(
    host=config.redis.host,          # localhost
    port=config.redis.port,          # 6379
    db=config.redis.db,              # 0
    decode_responses=True,           # String decode
)

storage = RedisStorage(redis=redis)
dp = Dispatcher(storage=storage)
```

=============================================================================
  10. TROUBLESHOOTING
=============================================================================

MUAMMO 1: Bot ishlamayapti
---------------------------

Sabab: Redis ishlamayapti

Yechim:
```bash
# Redis status tekshirish
sudo systemctl status redis

# Redis ishga tushirish
sudo systemctl start redis

# Redis test
redis-cli ping
# Javob: PONG bo'lishi kerak
```

MUAMMO 2: "Redis connection failed"
------------------------------------

Sabab: Redis'ga ulanib bo'lmayapti

Yechim:
1. Redis ishlab turganini tekshiring
2. .env faylida REDIS_HOST va REDIS_PORT to'g'ri ekanligini tekshiring
3. Firewall Redis port'ini blokladimi tekshiring

```bash
# Redis port'ni tekshirish
sudo netstat -tuln | grep 6379
```

MUAMMO 3: "Passport topilmadi" (lekin passport to'g'ri)
--------------------------------------------------------

Sabab: ERPNext API endpoint'i to'g'ri ishlamayapti

Yechim:
1. ERPNext'da endpoint qo'shilganligini tekshiring
2. API credentials to'g'ri ekanligini tekshiring
3. ERPNext log'larini ko'ring

```bash
# Bot log'larini ko'rish
tail -f logs/bot.log

# ERPNext log
# ERPNext ‚Üí Error Log doctype
```

MUAMMO 4: "Telegram ID topilmadi" (lekin avval ishlagan)
--------------------------------------------------------

Sabab: ERPNext'da telegram_id field'i bo'sh

Yechim:
1. ERPNext'da customer'ni oching
2. custom_telegram_id field'ida telegram_id borligini tekshiring
3. Agar yo'q bo'lsa - bot orqali qaytadan passport kiriting

MUAMMO 5: Mahsulot narxlari noto'g'ri
--------------------------------------

Sabab: Foiz hisoblash noto'g'ri

Yechim:
1. ERPNext'da Installment Application'ni tekshiring
2. custom_total_interest field'i to'g'ri hisoblanganligini tekshiring
3. ERPNext API'dagi calculate_products_with_interest() funksiyasini tekshiring

=============================================================================
  11. KEYINGI QADAMLAR
=============================================================================

TUGALLANISHI KERAK BO'LGAN HANDLER'LAR:
---------------------------------------

‚úÖ start.py - TAYYOR
‚úÖ passport.py - TAYYOR
‚ö†Ô∏è menu.py - YANGILASH KERAK
‚ö†Ô∏è contract.py - YANGILASH KERAK
‚ö†Ô∏è payments.py - YANGILASH KERAK
‚ùå reminders.py - YARATISH KERAK (yangi)

QANDAY DAVOM ETTIRISH?
----------------------

1. MENU.PY YANGILASH
   - Telegram ID orqali customer topish
   - Profile ko'rsatish

2. CONTRACT.PY YANGILASH
   - erp_get_customer_contracts() ishlatish
   - Mahsulotlarni format_contract_with_products() bilan ko'rsatish
   - Inline keyboard tugmalar: to'lov jadvali, to'lovlar tarixi

3. PAYMENTS.PY YANGILASH
   - erp_get_payment_history() ishlatish
   - format_payment_history() bilan ko'rsatish

4. REMINDERS.PY YARATISH
   - Yaqin to'lovlarni ko'rsatish
   - erp_get_upcoming_payments() ishlatish
   - format_upcoming_payments() bilan ko'rsatish

5. BACK BUTTON HANDLERS
   - back:menu ‚Üí Main menu
   - back:contracts ‚Üí Shartnomalar ro'yxati

6. NOTIFICATION WORKER YANGILASH
   - erp_get_customers_needing_reminders() ishlatish
   - Har xil reminder type'lar (5, 3, 1 kun oldin, kechikkan)

7. TESTING
   - Har bir handler'ni test qilish
   - Error case'larni test qilish
   - Production'ga chiqarish

=============================================================================

QOLLANMA TUGADI.

Savollar bo'lsa, kodni ko'ring - hamma joyda batafsil comment'lar yozilgan!

Professional kod yozing, documentation o'qing, test qiling! üöÄ

=============================================================================
